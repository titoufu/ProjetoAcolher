{% extends "operacoes/base.html" %}
{% load querystring %}

{% block title %}Consultas | Benefício → Assistidos{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- TÍTULO -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-1">Consulta — Assistidos por Benefício</h3>
      <div class="text-muted">Selecione um benefício e veja quem o recebe</div>
    </div>
  </div>

  <!-- CARD FILTROS -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">

        <div class="col-12 col-md-6">
          <label class="form-label">Benefício</label>
          <select name="beneficio_id" class="form-select">
            <option value="">— Selecione —</option>
            {% for b in beneficios %}
            <option value="{{ b.id }}"
                {% if beneficio_id|stringformat:"s" == b.id|stringformat:"s" %}selected{% endif %}>
                
                {{ b.nome }}
                (ativos: {{ b.ativos_count }} | encerrados: {{ b.encerrados_count }})
                #{{ b.id }}

            </option>
            {% endfor %}

          </select>

        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Status da atribuição</label>
          <select name="status" class="form-select">
            <option value="ativos" {% if status == "ativos" %}selected{% endif %}>Ativos</option>
            <option value="encerrados" {% if status == "encerrados" %}selected{% endif %}>Encerrados</option>
            <option value="todos" {% if status == "todos" %}selected{% endif %}>Todos</option>
          </select>
        </div>

        <div class="col-12 col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-outline-primary w-100">
            <i class="bi bi-funnel"></i> Filtrar
          </button>

          <a href="{% url 'consultas:beneficio_assistidos_consulta' %}" class="btn btn-outline-secondary w-100">
            <i class="bi bi-x-circle"></i> Limpar
          </a>
        </div>

      </form>
    </div>
  </div>

  <!-- CARD RESULTADOS -->
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">

      <!-- Total -->
      <div class="small">
        <span class="text-secondary me-2">Total:</span>
        <span class="px-3 py-1 border border-secondary rounded bg-light fw-semibold shadow-sm">
          {{ total }}
        </span>
      </div>

      <!-- Botão Imprimir -->
      <a href="{% url 'consultas:beneficio_assistidos_print' %}?{% qs_update request %}"
        class="btn btn-outline-dark btn-sm">
        <i class="bi bi-printer"></i> Imprimir
      </a>

    </div>

    <div class="card-body table-responsive">

      {% if not beneficio_id %}
        <div class="alert alert-info mb-0">
          Selecione um <strong>benefício</strong> e clique em <strong>Filtrar</strong>.
        </div>
      {% else %}

        <table class="table table-striped table-sm align-middle">
            <thead>
            <tr>

                <!-- Assistido -->
                <th>
                <a class="text-decoration-none"
                    href="?{% sort_qs request 'assistido__nome' %}">
                    Assistido {% sort_icon request 'assistido__nome' %}
                </a>
                </th>

                <!-- CPF (sem ordenação) -->
                <th style="width: 160px;">CPF</th>

                <!-- Status da atribuição -->
                <th style="width: 120px;">Status</th>
                
                <!-- Data de Início -->
                <th style="width: 130px;">
                <a class="text-decoration-none"
                    href="?{% sort_qs request 'data_inicio' %}">
                    Início {% sort_icon request 'data_inicio' %}
                </a>
                </th>

                <!-- Data de Término -->
                <th style="width: 130px;">
                <a class="text-decoration-none"
                    href="?{% sort_qs request 'data_termino' %}">
                    Término {% sort_icon request 'data_termino' %}
                </a>
                </th>

            </tr>
            </thead>


          <tbody>
            {% for a in atribuicoes %}
              <tr>
                <td>
                  <a class="fw-semibold text-decoration-none"
                     href="{% url 'assistidos:assistido_detail' a.assistido.id %}">
                    {{ a.assistido.nome|title }}
                  </a>
                </td>

                <td>{{ a.assistido.cpf|default:"—" }}</td>

                <td>
                  {% if a.ativo %}
                    <span class="badge text-bg-success">Ativa</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Encerrada</span>
                  {% endif %}
                </td>

                <td>
                  {% if a.data_inicio %}
                    {{ a.data_inicio|date:"d/m/Y" }}
                  {% else %}
                    —
                  {% endif %}
                </td>

                <td>
                  {% if a.data_termino %}
                    {{ a.data_termino|date:"d/m/Y" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">
                  Nenhuma atribuição encontrada para os filtros informados.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
