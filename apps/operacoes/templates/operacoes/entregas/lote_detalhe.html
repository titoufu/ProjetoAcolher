{% extends "operacoes/base.html" %}

{% block title %}Entrega{% endblock %}

{% block content %}
<div class="container py-3">

  <!-- Cabeçalho -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-0">Entrega do Lote</h2>
      <div class="text-muted">
        Data: <strong>{{ lote.data_entrega|date:"d/m/Y" }}</strong> —
        Benefício: <strong>{{ lote.beneficio.nome }}</strong>
        &nbsp;|&nbsp; Lote: <strong>#{{ lote.id }}</strong>
      </div>
    </div>

    <div class="d-flex gap-2">
      <!-- Imprimir -->
      <a class="btn btn-outline-dark"
         href="{% url 'consultas:entregas_lote_print' %}?lote_id={{ lote.id }}"
         target="_blank">
        <i class="bi bi-printer"></i> Imprimir
      </a>

      <!-- Voltar -->
      <a class="btn btn-outline-secondary" href="{% url 'entregas:lote_lista' %}">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>
  </div>

  <!-- Card resumo -->
  <div class="card shadow-sm mb-3">
    <div class="card-body d-flex gap-2 flex-wrap">
      <span class="badge text-bg-primary">Total: {{ total }}</span>
      <span class="badge text-bg-success">Entregues: {{ entregues }}</span>
      <span class="badge text-bg-secondary">Pendentes: {{ pendentes }}</span>
    </div>
  </div>

  <!-- Card checklist -->
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}

        <div class="table-responsive">
          <table id="tabela-checklist" class="table table-hover align-middle">
            <thead>
              <tr>
                <th style="width:160px;">Status</th>
                <th>Nome</th>
                <th style="width:180px;">Telefone</th>
                <th style="width:140px;">Data Nasc.</th>
              </tr>
            </thead>

            <tbody>
              {% for item in itens %}
              <tr class="{% if item.entregue %}table-success{% endif %}">
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <input class="form-check-input"
                           type="checkbox"
                           name="entregue"
                           value="{{ item.id }}"
                           {% if item.entregue %}checked{% endif %}>

                    {% if item.entregue %}
                      <span class="badge text-bg-success">ENTREGUE</span>
                    {% else %}
                      <span class="badge text-bg-secondary">PENDENTE</span>
                    {% endif %}
                  </div>
                </td>

                <td>{{ item.atribuicao.assistido.nome|title }}</td>
                <td>{{ item.atribuicao.assistido.telefone_formatado }}</td>
                <td>{{ item.atribuicao.assistido.data_nascimento|date:"d/m/Y" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-muted">
                  Nenhum assistido encontrado para este lote.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <button type="submit" class="btn btn-primary mt-3">
          <i class="bi bi-save"></i> Salvar checklist
        </button>
      </form>
    </div>
  </div>

</div>

<script>
(function () {
  const tabela = document.getElementById("tabela-checklist");
  if (!tabela) return;

  tabela.addEventListener("change", function (ev) {
    const cb = ev.target;
    if (!(cb instanceof HTMLInputElement)) return;
    if (cb.type !== "checkbox") return;
    if (cb.name !== "entregue") return;

    const tr = cb.closest("tr");
    if (!tr) return;

    // badge é o primeiro <span class="badge"> dentro da mesma célula
    const td = cb.closest("td");
    const badge = td ? td.querySelector("span.badge") : null;
    if (!badge) return;

    if (cb.checked) {
      tr.classList.add("table-success");
      badge.classList.remove("text-bg-secondary");
      badge.classList.add("text-bg-success");
      badge.textContent = "ENTREGUE";
    } else {
      tr.classList.remove("table-success");
      badge.classList.remove("text-bg-success");
      badge.classList.add("text-bg-secondary");
      badge.textContent = "PENDENTE";
    }
  });
})();
</script>

{% endblock %}
